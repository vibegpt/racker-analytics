// Racker Analytics - Prisma Schema
// Smart link tracking & revenue attribution platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  url      = env("DATABASE_URL")
  provider = "postgresql"
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk user ID
  email     String   @unique
  name      String?
  avatarUrl String?
  
  // Stripe Connect (for creator revenue tracking)
  stripeConnectId       String?   @unique // Stripe Connect account ID
  stripeConnectStatus   String?   // pending, active, restricted, disabled
  stripeConnectOnboardedAt DateTime?
  
  // Onboarding status
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  smartLinks      SmartLink[]
  sales           Sale[]
  attributions    Attribution[]
  socialAccounts  SocialAccount[]
  subscription    Subscription?
  apiKeys         ApiKey[]
  teamMemberships TeamMember[]
  ownedTeams      Team[]        @relation("TeamOwner")
  
  @@index([clerkId])
  @@index([email])
  @@index([stripeConnectId])
}

// ============================================================================
// SUBSCRIPTIONS & BILLING
// ============================================================================

enum SubscriptionTier {
  HUSTLER  // Free tier
  CREATOR  // $29/mo - Sentiment analysis, advanced correlation
  EMPIRE   // $299/mo - White label, team seats
}

model Subscription {
  id     String           @id @default(cuid())
  userId String           @unique
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tier              SubscriptionTier @default(HUSTLER)
  status            String           @default("active") // active, canceled, past_due
  stripeCustomerId  String?          @unique
  stripePriceId     String?
  stripeSubId       String?          @unique
  
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([stripeCustomerId])
}

// ============================================================================
// TEAMS (Empire Tier)
// ============================================================================

model Team {
  id      String @id @default(cuid())
  name    String
  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  members TeamMember[]
  
  @@index([ownerId])
}

model TeamMember {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role String @default("member") // owner, admin, member
  
  joinedAt DateTime @default(now())
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

// ============================================================================
// SMART LINKS (Core Feature)
// ============================================================================

enum Platform {
  TWITTER
  YOUTUBE
  INSTAGRAM
  TIKTOK
  TWITCH
  NEWSLETTER
  DISCORD
  OTHER
}

model SmartLink {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  slug         String   @unique // The short code: crtr.fy/{slug}
  originalUrl  String   // Destination URL (Stripe, Patreon, etc.)
  platform     Platform // Which platform this link is for
  
  metaTitle       String?
  metaDescription String?
  metaImage       String?
  
  active     Boolean  @default(true)
  archived   Boolean  @default(false)
  
  // Campaign tracking
  campaignName String?
  notes        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  clicks       Click[]
  attributions Attribution[]
  
  @@index([userId])
  @@index([slug])
  @@index([platform])
  @@index([active])
}

// ============================================================================
// CLICKS (Tracking)
// ============================================================================

model Click {
  id          String    @id @default(cuid())
  linkId      String
  link        SmartLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  // Timestamp
  clickedAt DateTime @default(now())
  
  // User tracking (for attribution)
  ipAddress     String?
  userAgent     String?
  referer       String?
  
  // Geo data (from IP or browser)
  country       String?
  region        String?
  city          String?
  latitude      Float?
  longitude     Float?
  
  // Device info
  deviceType    String? // mobile, desktop, tablet
  browser       String?
  os            String?
  
  // UTM params (if present)
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmTerm       String?
  utmContent    String?
  
  // Relations
  attributions Attribution[]
  
  @@index([linkId])
  @@index([clickedAt])
  @@index([ipAddress])
  @@index([country])
}

// ============================================================================
// SALES (Stripe Revenue)
// ============================================================================

model Sale {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stripe data
  stripePaymentIntentId String  @unique
  stripeCustomerId      String?
  
  // Sale details
  amount       Int      // Amount in cents
  currency     String   @default("usd")
  status       String   // succeeded, pending, failed
  
  // Customer info (for attribution matching)
  customerEmail String?
  customerIp    String?
  customerName  String?
  
  // Location data from Stripe
  country String?
  region  String?
  city    String?
  
  // Metadata
  productName String?
  metadata    Json? // Arbitrary Stripe metadata
  
  createdAt DateTime @default(now()) // When the sale occurred
  updatedAt DateTime @updatedAt
  
  // Relations
  attributions Attribution[]
  
  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([customerEmail])
  @@index([customerIp])
  @@index([createdAt])
  @@index([country])
}

// ============================================================================
// ATTRIBUTION (The Magic!)
// ============================================================================

enum AttributionStatus {
  PENDING    // Initial state
  MATCHED    // Automatically matched
  CONFIRMED  // User confirmed
  REJECTED   // User rejected
  UNCERTAIN  // Needs manual review
}

model Attribution {
  id String @id @default(cuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clickId String
  click   Click  @relation(fields: [clickId], references: [id], onDelete: Cascade)
  
  saleId String
  sale   Sale   @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  linkId String
  link   SmartLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  // Attribution confidence
  confidenceScore Float  @default(0.0) // 0.0 to 1.0
  status          AttributionStatus @default(PENDING)
  
  // Time delta between click and sale
  timeDeltaMinutes Int? // How many minutes between click and sale
  
  // Matching factors
  matchedBy Json? // { ipMatch: true, emailMatch: false, geoMatch: true, timeWindow: true }
  
  // Revenue split (if multiple attributions)
  revenueShare Float @default(1.0) // 0.0 to 1.0 (percentage of sale attributed)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([clickId, saleId]) // One click can only be attributed to one sale
  @@index([userId])
  @@index([linkId])
  @@index([status])
  @@index([confidenceScore])
}

// ============================================================================
// SOCIAL ACCOUNTS (OAuth Connections)
// ============================================================================

enum SocialPlatform {
  TWITTER
  YOUTUBE
  INSTAGRAM
  TIKTOK
  TWITCH
}

model SocialAccount {
  id     String         @id @default(cuid())
  userId String
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  platform     SocialPlatform
  platformId   String         // Twitter user ID, YouTube channel ID, etc.
  username     String?
  displayName  String?
  avatarUrl    String?
  
  // OAuth tokens
  accessToken  String?
  refreshToken String?
  tokenExpiry  DateTime?
  
  // Metadata
  followerCount Int?
  isVerified    Boolean @default(false)
  
  connected   Boolean  @default(true)
  connectedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  posts SocialPost[]
  
  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
  @@index([platformId])
}

// ============================================================================
// SOCIAL POSTS (Content Tracking)
// ============================================================================

model SocialPost {
  id              String        @id @default(cuid())
  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  
  platform   SocialPlatform
  platformId String // Tweet ID, YouTube video ID, etc.
  
  content  String?
  url      String?
  mediaUrl String?
  
  // Engagement metrics
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)
  views    Int @default(0)
  
  // Sentiment analysis (Creator tier+)
  sentimentScore   Float? // -1.0 (negative) to 1.0 (positive)
  sentimentLabel   String? // positive, negative, neutral
  hypeScore        Float? // Custom hype metric
  
  postedAt  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([platformId, platform])
  @@index([socialAccountId])
  @@index([platform])
  @@index([postedAt])
}

// ============================================================================
// API KEYS & SETTINGS
// ============================================================================

model ApiKey {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String // "Production API", "Test Key", etc.
  keyHash     String @unique // Hashed API key
  keyPreview  String // Last 4 characters for display
  
  active      Boolean  @default(true)
  lastUsedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([keyHash])
}

// ============================================================================
// ANALYTICS & INSIGHTS
// ============================================================================

model DailyStats {
  id     String   @id @default(cuid())
  userId String
  date   DateTime @db.Date
  
  // Smart link stats
  totalClicks       Int @default(0)
  uniqueVisitors    Int @default(0)
  
  // Revenue stats
  totalSales        Int @default(0)
  totalRevenue      Int @default(0) // in cents
  attributedRevenue Int @default(0) // in cents
  
  // Top performing
  topLink     String? // slug of best performing link
  topPlatform String? // best performing platform
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}
