// Racker Analytics - Prisma Schema
// Smart link tracking & revenue attribution platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  url      = env("DATABASE_URL")
  provider = "postgresql"
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  name      String?
  avatarUrl String?
  
  stripeConnectId          String?   @unique
  stripeConnectStatus      String?
  stripeConnectOnboardedAt DateTime?
  
  onboardingCompleted   Boolean   @default(false)
  onboardingCompletedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  smartLinks      SmartLink[]
  products        Product[]
  sales           Sale[]
  attributions    Attribution[]
  socialAccounts  SocialAccount[]
  subscription    Subscription?
  apiKeys         ApiKey[]
  teamMemberships TeamMember[]
  ownedTeams      Team[]        @relation("TeamOwner")
  
  @@index([clerkId])
  @@index([email])
  @@index([stripeConnectId])
}

enum SubscriptionTier {
  HUSTLER
  CREATOR
  EMPIRE
}

model Subscription {
  id     String           @id @default(cuid())
  userId String           @unique
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tier              SubscriptionTier @default(HUSTLER)
  status            String           @default("active")
  stripeCustomerId  String?          @unique
  stripePriceId     String?
  stripeSubId       String?          @unique
  
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([stripeCustomerId])
}

model Team {
  id      String @id @default(cuid())
  name    String
  ownerId String
  owner   User   @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  members TeamMember[]
  
  @@index([ownerId])
}

model TeamMember {
  id     String @id @default(cuid())
  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role     String   @default("member")
  joinedAt DateTime @default(now())
  
  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum Platform {
  TWITTER
  YOUTUBE
  INSTAGRAM
  TIKTOK
  TWITCH
  NEWSLETTER
  DISCORD
  OTHER
}

enum RouterType {
  STANDARD
  GEO_AFFILIATE
}

// ============================================================================
// PRODUCTS (Groups links by destination for per-post tracking)
// ============================================================================

model Product {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String   // "Amazon Fire Stick", "My Course", etc.
  shortCode   String   // Base for slug generation, e.g., "fire"
  destinationUrl String // The actual affiliate/product URL

  // Optional geo-routing config (applies to all child links)
  routerType   RouterType @default(STANDARD)
  routerConfig Json?

  // Metadata
  imageUrl    String?
  description String?

  active   Boolean @default(true)
  archived Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links SmartLink[]

  @@unique([userId, shortCode])
  @@index([userId])
  @@index([active])
}

model SmartLink {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional parent product (for per-post tracking)
  productId   String?
  product     Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  linkNumber  Int?      // Sequential number within product+platform (001, 002, etc.)

  slug         String     @unique
  originalUrl  String
  platform     Platform
  
  routerType   RouterType @default(STANDARD)
  routerConfig Json?
  
  metaTitle       String?
  metaDescription String?
  metaImage       String?
  
  active   Boolean @default(true)
  archived Boolean @default(false)
  
  campaignName String?
  notes        String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  clicks       Click[]
  attributions Attribution[]
  
  @@index([userId])
  @@index([productId])
  @@index([slug])
  @@index([platform])
  @@index([active])
  @@index([routerType])
}

model Click {
  id     String    @id @default(cuid())
  linkId String
  link   SmartLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  clickedAt DateTime @default(now())
  
  ipAddress String?
  userAgent String?
  referer   String?
  
  country   String?
  region    String?
  city      String?
  latitude  Float?
  longitude Float?
  
  deviceType String?
  browser    String?
  os         String?
  
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  
  routedTo   String?
  routeMatch String?
  
  attributions Attribution[]
  
  @@index([linkId])
  @@index([clickedAt])
  @@index([ipAddress])
  @@index([country])
}

model Sale {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  stripePaymentIntentId String  @unique
  stripeCustomerId      String?
  
  amount   Int
  currency String @default("usd")
  status   String
  
  customerEmail String?
  customerIp    String?
  customerName  String?
  
  country String?
  region  String?
  city    String?
  
  productName String?
  metadata    Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  attributions Attribution[]
  
  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([customerEmail])
  @@index([customerIp])
  @@index([createdAt])
  @@index([country])
}

enum AttributionStatus {
  PENDING
  MATCHED
  CONFIRMED
  REJECTED
  UNCERTAIN
}

model Attribution {
  id String @id @default(cuid())
  
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clickId String
  click   Click @relation(fields: [clickId], references: [id], onDelete: Cascade)
  
  saleId String
  sale   Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)
  
  linkId String
  link   SmartLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  confidenceScore  Float             @default(0.0)
  status           AttributionStatus @default(PENDING)
  timeDeltaMinutes Int?
  matchedBy        Json?
  revenueShare     Float             @default(1.0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([clickId, saleId])
  @@index([userId])
  @@index([linkId])
  @@index([status])
  @@index([confidenceScore])
}

enum SocialPlatform {
  TWITTER
  YOUTUBE
  INSTAGRAM
  TIKTOK
  TWITCH
}

model SocialAccount {
  id     String         @id @default(cuid())
  userId String
  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  platform    SocialPlatform
  platformId  String
  username    String?
  displayName String?
  avatarUrl   String?
  
  accessToken  String?
  refreshToken String?
  tokenExpiry  DateTime?
  
  followerCount Int?
  isVerified    Boolean @default(false)
  
  connected   Boolean  @default(true)
  connectedAt DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  posts SocialPost[]
  
  @@unique([userId, platform])
  @@index([userId])
  @@index([platform])
  @@index([platformId])
}

model SocialPost {
  id              String        @id @default(cuid())
  socialAccountId String
  socialAccount   SocialAccount @relation(fields: [socialAccountId], references: [id], onDelete: Cascade)
  
  platform   SocialPlatform
  platformId String
  
  content  String?
  url      String?
  mediaUrl String?
  
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)
  views    Int @default(0)
  
  sentimentScore Float?
  sentimentLabel String?
  hypeScore      Float?
  
  postedAt  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([platformId, platform])
  @@index([socialAccountId])
  @@index([platform])
  @@index([postedAt])
}

model ApiKey {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name       String
  keyHash    String    @unique
  keyPreview String
  
  active     Boolean   @default(true)
  lastUsedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([keyHash])
}

model DailyStats {
  id     String   @id @default(cuid())
  userId String
  date   DateTime @db.Date

  totalClicks       Int @default(0)
  uniqueVisitors    Int @default(0)
  totalSales        Int @default(0)
  totalRevenue      Int @default(0)
  attributedRevenue Int @default(0)

  topLink     String?
  topPlatform String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================================================
// CREATOR PROFILES & INSIGHTS
// ============================================================================

enum CreatorNiche {
  TRAVEL
  GAMING
  FITNESS
  BEAUTY
  TECH
  FOOD
  FASHION
  MUSIC
  EDUCATION
  FINANCE
  LIFESTYLE
  ENTERTAINMENT
  OTHER
}

model CreatorProfile {
  id     String @id @default(cuid())
  userId String @unique

  niche         CreatorNiche @default(OTHER)
  subNiche      String?      // e.g., "camping", "backpacking" for TRAVEL
  country       String?      // Creator's primary country
  region        String?      // State/Province
  audienceSize  Int?         // Estimated total audience

  contentTypes  String[]     // ["video", "short", "post", "stream"]
  primaryPlatform Platform?  // Where they're biggest

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([niche])
  @@index([country])
  @@index([primaryPlatform])
}

// Tracks learned patterns from click/conversion data
model InsightPattern {
  id String @id @default(cuid())

  // Dimension being tracked
  dimension  String   // "time_of_day", "day_of_week", "platform", "niche", "geo", "content_type"
  segment    String   // e.g., "9", "monday", "youtube", "travel", "US", "video"

  // Optional filters (for combined insights)
  niche      CreatorNiche?
  platform   Platform?
  country    String?

  // Aggregated metrics
  totalClicks     Int   @default(0)
  totalConversions Int  @default(0)
  totalRevenue    Int   @default(0)  // in cents
  sampleSize      Int   @default(0)

  // Calculated scores (updated by engine)
  clickRate       Float @default(0)  // clicks per impression estimate
  conversionRate  Float @default(0)  // conversions / clicks
  avgRevenuePerClick Float @default(0)
  performanceScore Float @default(0) // Normalized 0-1 score

  // Trend tracking
  trend7d   Float @default(0)  // % change vs 7 days ago
  trend30d  Float @default(0)  // % change vs 30 days ago

  // Learning metadata
  confidence Float @default(0)   // Statistical confidence (0-1)
  lastUpdated DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dimension, segment, niche, platform, country])
  @@index([dimension])
  @@index([niche])
  @@index([platform])
  @@index([performanceScore])
}

// Stores model weights learned over time
model InsightModel {
  id String @id @default(cuid())

  version     String @default("v1.0.0")

  // Global weights (learned from all data)
  timeWeight     Float @default(0.3)
  platformWeight Float @default(0.25)
  nicheWeight    Float @default(0.2)
  geoWeight      Float @default(0.15)
  contentWeight  Float @default(0.1)

  // Platform-specific decay rates (lambda)
  platformLambdas Json @default("{}")

  // Training stats
  trainingCount Int @default(0)
  accuracy      Float @default(0)

  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// Individual click events for learning (recent only, pruned over time)
model ClickEvent {
  id String @id @default(cuid())

  // Link info
  linkId   String
  platform Platform

  // Creator info (denormalized for fast queries)
  creatorNiche    CreatorNiche?
  creatorCountry  String?

  // Click context
  clickedAt       DateTime
  hourOfDay       Int       // 0-23
  dayOfWeek       Int       // 0-6 (Sunday = 0)
  monthOfYear     Int       // 1-12

  // Visitor geo
  visitorCountry  String?
  visitorRegion   String?

  // Device/content
  deviceType      String?   // mobile, desktop, tablet
  contentType     String?   // video, post, stream, etc.

  // Outcome
  converted       Boolean @default(false)
  revenueAmount   Int?    // cents

  createdAt DateTime @default(now())

  @@index([platform])
  @@index([creatorNiche])
  @@index([hourOfDay])
  @@index([dayOfWeek])
  @@index([clickedAt])
  @@index([converted])
}

// ============================================================================
// LEAD TRACKING (Forms & Page Views)
// ============================================================================

// Tracks page views on destination sites (via tracking script)
model PageView {
  id String @id @default(cuid())

  // Link that drove this visit
  linkId    String?

  // Tracking identifiers
  trackerId   String    // rckr_xxx from cookie/URL param
  sessionId   String?   // Browser session ID
  fingerprint String?   // Browser fingerprint for matching

  // Page info
  pageUrl     String
  pageTitle   String?
  referrer    String?

  // Visitor info
  ipAddress   String?
  userAgent   String?
  country     String?
  region      String?
  city        String?
  deviceType  String?
  browser     String?
  os          String?

  // Timing
  viewedAt    DateTime @default(now())
  timeOnPage  Int?     // seconds (updated via beacon)

  createdAt DateTime @default(now())

  @@index([trackerId])
  @@index([linkId])
  @@index([viewedAt])
  @@index([ipAddress])
}

// Tracks form submissions (conversions without payment)
model FormConversion {
  id String @id @default(cuid())

  // Link attribution
  linkId    String?
  clickId   String?    // If we can match to original click

  // Tracking identifiers
  trackerId   String?   // rckr_xxx
  fingerprint String?
  ipAddress   String?

  // Form details
  formId      String?   // ID/name of the form
  formName    String?   // Human-readable name
  pageUrl     String    // Page where form was submitted

  // Lead info (optional - what user submitted)
  email       String?
  name        String?
  phone       String?
  metadata    Json?     // Any other form fields

  // Attribution matching
  confidenceScore Float @default(0)
  matchedBy       Json?  // How we matched this to a click

  // Timing
  submittedAt DateTime @default(now())
  timeSinceClick Int?   // Minutes between click and form submit

  createdAt DateTime @default(now())

  @@index([trackerId])
  @@index([linkId])
  @@index([clickId])
  @@index([email])
  @@index([submittedAt])
  @@index([ipAddress])
}
